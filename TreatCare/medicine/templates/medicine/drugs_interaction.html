{% extends 'base.html' %}

{% block main_content %}
<div class="container">
    <div class="box-xs">
        <div class="box-title">
            <div class="row">
                <div class="col-md-6">
                    Insira um medicamento:
                    <input id="drug_search" class="form-control" type="text" name="name" value="" placeholder="Pesquisar">
                </div>
            </div>
        </div>
        <div class="box-body">
            <div class="row">
                <div class="col-md-6" >
                    <div id="selected_drugs" class="list-group"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block main_script %}
<script type="text/javascript">
    var selectedItems = {
        items: [],
        callback: proccessInteractions,
        add: function (item) {
            var idList = []

            for (i in this.items) {
                if(this.items[i]['id'] == item.id) {
                    return
                }
            }
            this.items.push(item);
            this.addItemElem(item);
            this.callback();
        },
        removeItemById: function (id) {
            var matchedItems = this.items.filter (function (item) {
                return item.id == id
            });

            for (item in matchedItems) {
                var index = this.items.indexOf(matchedItems[item]);
                if(index >= 0) {
                    this.items.splice(index, 1);
                }
            }
            this.removeItemElem(id);
            this.callback();
        },
        addItemElem: function (item) {
            var span = $('<span>').attr({
                ariaHidden: 'true',
            }).html('&times');

            var closeBtn = $('<button>').attr({
                class: 'close',
                type: 'button',
                ariaLabel: 'Close',
                onclick:'removeItem(this)',
            }).html(span);

            var listGroupItemHeading = $('<h5>').addClass('list-group-item-heading').append(item.name).append(closeBtn);
            var laboratory = $('<p>').addClass('list-group-item-text').html(item.laboratory);
            var active_principle = $('<p>').addClass('list-group-item-text').append(item.active_principle);
            var hidenId = $('<input>').attr({
                type: 'hidden',
                class: 'item_id',
                value: item.id,
            });
            var listGroupItem = $('<div>').addClass('list-group-item').append(hidenId).append(listGroupItemHeading).append(laboratory).append(active_principle);

            $("#selected_drugs").append(listGroupItem);
            $("#drug_search").val(item.name);
        },
        removeItemElem: function (itemId) {
            $(".item_id[value='"+ itemId +"']").parent().remove();
        }
    }


    $("#drug_search").autocomplete({
        minLength: 3,
        source: function (request, response) {
            $.ajax( {
                url: "/medicine/",
                data: {
                    q: request.term
                },
                success: function (data) {
                    response( data.length === 1 && data[ 0 ].length === 0 ? [] : data );
                }
            } );
        },
        select: function (event, ui) {
            selectedItems.add(ui.item);
            return false;
        }
    })
    .autocomplete( "instance" )._renderItem = function(ul, item) {
      return $("<li>")
        .append("<div>" + item.name + "<br>" + "<span class='presentation'>" + item.active_principle + "<span>" + "</div>" )
        .appendTo(ul);
    };

    function removeItem(elem) {
        var parent = $(elem).parent().parent();
        var elemId = $(parent).find(".item_id:first").val();
        selectedItems.removeItemById(elemId);
    }

    function proccessInteractions () {
        if (selectedItems.items.length > 1) {
            console.log("Proccess Interactions ... ")
        }
    }
</script>
{% endblock %}
